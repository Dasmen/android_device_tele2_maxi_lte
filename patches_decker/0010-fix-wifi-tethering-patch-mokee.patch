From af532c11133dd9a5857eb8aa4b3a3ac54f28e66c Mon Sep 17 00:00:00 2001
From: DeckerSU <support@decker.su>
Date: Tue, 21 Feb 2017 05:48:55 +0300
Subject: [PATCH] fix wifi tethering patch [mokee]

Change-Id: I3aa473f72eecfda950fd8b887f3fc4503cded24c
---
 server/NatController.cpp    | 6 ++++--
 server/SoftapController.cpp | 6 ++++--
 2 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/server/NatController.cpp b/server/NatController.cpp
index cda8f5f..5c518ce 100644
--- a/server/NatController.cpp
+++ b/server/NatController.cpp
@@ -376,8 +376,10 @@ int NatController::setForwardRules(bool add, const char *intIface, const char *e
         goto err_return;
     }
 
-    if (runCmd(ARRAY_SIZE(cmd4), cmd4) && add) {
-        rc = -1;
+    // Revert "Don't start tethering if IPv6 RPF is not supported."
+    // STOPSHIP: Make this an error.
+    if (runCmd(ARRAY_SIZE(cmd4), cmd4) && add && false /* STOPSHIP */) {
+    rc = -1;
         goto err_rpfilter;
     }
 
diff --git a/server/SoftapController.cpp b/server/SoftapController.cpp
index 27ed684..41d02e4 100755
--- a/server/SoftapController.cpp
+++ b/server/SoftapController.cpp
@@ -54,7 +54,8 @@ using android::base::WriteStringToFile;
 #endif
 
 #ifdef LIBWPA_CLIENT_EXISTS
-static const char HOSTAPD_UNIX_FILE[]    = "/data/misc/wifi/hostapd/wlan0";
+//static const char HOSTAPD_UNIX_FILE[]    = "/data/misc/wifi/hostapd/wlan0";
+static const char HOSTAPD_UNIX_FILE[]    = "/data/misc/wifi/hostapd/ap0";
 static const char HOSTAPD_DHCP_DIR[]    = "/data/misc/dhcp";
 #endif
 static const char HOSTAPD_CONF_FILE[]    = "/data/misc/wifi/hostapd.conf";
@@ -282,7 +283,8 @@ int SoftapController::setSoftap(int argc, char *argv[]) {
             "hw_mode=%c\n"
             "ignore_broadcast_ssid=%d\n"
             "wowlan_triggers=any\n",
-            argv[2], argv[3], channel, (channel <= 14) ? 'g' : 'a', hidden));
+            // argv[2], argv[3], channel, (channel <= 14) ? 'g' : 'a', hidden));
+            "ap0", argv[3], channel, (channel <= 14) ? 'g' : 'a', hidden));
 
     std::string fbuf;
     if (argc > 7) {
-- 
2.7.4

